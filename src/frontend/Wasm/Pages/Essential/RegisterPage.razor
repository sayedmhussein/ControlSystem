@using WeeControl.Host.WebApiService
@using Microsoft.AspNetCore.Components
@using WeeControl.Core.DataTransferObject.Contexts.Essentials
@using WeeControl.Core.SharedKernel
@using WeeControl.Core.SharedKernel.Contexts.Essentials
@using WeeControl.Host.WebApiService.Contexts.Constants
@using WeeControl.Host.WebApiService.Contexts.Essentials
@using WeeControl.Frontend.Wasm.Pages.Essential.RegistrationComponents

@attribute [Route(ApplicationPages.Essential.RegisterPage)]
@attribute [AllowAnonymous]

@inject IConstantValue ConstantValue
@inject IUserService UserService
@inject IDialogService DialogService

<MudCard Style="align-content: center; align-self: center; justify-content: start">
    
    @if (isLoading)
    {
        <MudProgressCircular Color="Color.Default" Indeterminate="true" />
    }
    else
    {
        <MudExpansionPanels>
            <MudExpansionPanel Text="Personal Details"  @bind-IsExpanded="@expandPerson" IsInitiallyExpanded="@true">
                <PersonComponent PersonalModelCallback="PersonalModelSubmitted"></PersonComponent>
            </MudExpansionPanel>
            <MudExpansionPanel Text="Credential Details" @bind-IsExpanded="@expandUser">
                <UserComponent UserModelCallback="UserModelSubmitted"></UserComponent>
            </MudExpansionPanel>
            <MudExpansionPanel Text="Other Details" @bind-IsExpanded="@expandCustomer">
                <CustomerComponent Model="@model.Customer"></CustomerComponent>
            </MudExpansionPanel>
            <MudExpansionPanel Text="Finalizing" @bind-IsExpanded="@expandFinal">
                <MudGrid Spacing="5">
                                    <MudItem xs="12" sm="12">
                                        <MudRadioGroup T="string" Required="true" RequiredError="Account type is required!">
                                            <MudRadio Option="@("Personal")">Personal</MudRadio>
                                            <MudRadio Option="@("Professional")">Professional</MudRadio>
                                        </MudRadioGroup>
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudCheckBox T="bool" Required="true" RequiredError="You must agree" Label="I agree!"/>
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudLink OnClick="@(() => DialogService.Show<TermsComponent>("Terms"))">Read Terms</MudLink>
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudButton Variant="Variant.Text" ButtonType="ButtonType.Submit" Disabled="@isLoading">Register</MudButton>
                                    </MudItem>
                                </MudGrid>
            </MudExpansionPanel>
        </MudExpansionPanels>
    }
    
</MudCard>

@code {
    private bool isLoading;
    
    private bool expandPerson;
    private bool expandUser;
    private bool expandCustomer;
    private bool expandFinal;
    
    private readonly UserProfileDto model = new();

    private async Task Register()
    {
        isLoading = true;
        await Task.Delay(3000);
        await UserService.AddUser(model);
        isLoading = false;
    }

    private Task PersonalModelSubmitted(PersonModel obj)
    {
        if (obj.IsValidEntityModel())
        {
            model.Person = obj;
            expandPerson = false;
            expandUser = true;
        }

        return Task.CompletedTask;
    }

    private Task UserModelSubmitted(UserModel obj)
    {
        if (obj.IsValidEntityModel())
        {
            model.User = obj;
            expandUser = false;
            expandCustomer = true;
        }

        return Task.CompletedTask;
    }

}